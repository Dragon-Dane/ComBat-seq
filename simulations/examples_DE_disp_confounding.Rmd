---
title: "Application of ComBat-seq on simulated datasets"
subtitle: "Levels of dispersion differences and confounding"
author: Yuqing Zhang
date: "`r Sys.Date()`"
output:
  html_notebook:
    theme: united
    toc: yes
---

## About this simulation

From previous analysis (*"powerdown_unbalanced"*), it appears that ComBat-seq works when there is variance batch effect & when there is some level of confounding between batch and condition (i.e. in unbalanced study design). We dig deeper in these two factors.

## Setup

* Mean fold changes: Biological - 2, Batch - 1.5 
* Dispersion: Batch 1 - 0.15, Batch 2 - 0.15***dispersion fold level**
* Study design: Unbalanced with **different levels of confounding**
* Reads per gene: Median 120 (coverage 5)
* Total number of samples: 20

Note that these parameters are consistent with my observations from real datasets. 

Two factors under examination are dispersion fold level and level of confounding. Confounding level is measured by how many percentage of samples in batch 1 is control samples. 2 batches have the same size. Grid for the two factors:

* Dispersion level: 1 (no dispersion difference), 2, 3, 4, 5
* Confounding: 0.5 (no confounding), 0.4, 0.3, 0.2

```{r, echo=FALSE, results='hide'}
rm(list=ls())
sapply(c("ggplot2", "gridExtra", "reshape2"), require, character.only=TRUE)
results_dir <- "~/Google Drive/ComBat_seq/DE_analysis_disp_confounding"
#results_dir <- "~/yuqingz/ComBat_seq/DE_disp_confounding"

disp_level_vec <- 1:5
confounding_level_vec <- seq(from=0.5,to=0.2,by=-0.1)
```

<!--
<img src="/Users/yuqingz/Dropbox/Work/ComBat_Seq/study_design_4.png" width="425">
-->


## Dispersion differences only 

When there is no confounding effect (i.e. balanced design):

```{r, echo=FALSE, results='hide', fig.width=4, fig.height=10}
p_tpr <- p_fpr <- list()
for(i in 1:length(disp_level_vec)){
  exp_name <- paste0("simDispConfound_dispFC", disp_level_vec[i], "_percent05")
  tpr_res <- read.csv(file.path(results_dir, sprintf('tpr_%s.csv', exp_name)))
  fpr_res <- read.csv(file.path(results_dir, sprintf('fpr_%s.csv', exp_name)))
  tpr_res <- tpr_res[, c(1:5,7:8)]
  fpr_res <- fpr_res[, c(1:5,7:8)]
  
  p_tpr[[i]] <- ggplot(melt(tpr_res), aes(x=variable, y=value)) +
    geom_boxplot() +
    labs(x="", y="TPR", title=paste("Dispersion level", disp_level_vec[i])) +
    theme(axis.text.x=element_text(angle=45, hjust=1))
  p_fpr[[i]] <- ggplot(melt(fpr_res), aes(x=variable, y=value)) +
    geom_boxplot() +
    geom_hline(yintercept=0.05, col="red") +
    labs(x="", y="FPR", title=paste("Dispersion level", disp_level_vec[i])) +
    theme(axis.text.x=element_text(angle=45, hjust=1))
}

grid.arrange(p_fpr[[1]], p_tpr[[1]], p_fpr[[2]], p_tpr[[2]], 
             p_fpr[[3]], p_tpr[[3]], p_fpr[[4]], p_tpr[[4]],
             p_fpr[[5]], p_tpr[[5]], ncol=2)
```



## Confounding only

When there is no dispersion difference between simulated data:

```{r, echo=FALSE, results='hide', fig.width=4, fig.height=8}
p_tpr <- p_fpr <- list()
for(j in 1:length(confounding_level_vec)){
  exp_name <- paste0("simDispConfound_dispFC1_percent", gsub(".","", confounding_level_vec[j], fixed=T))
  tpr_res <- read.csv(file.path(results_dir, sprintf('tpr_%s.csv', exp_name)))
  fpr_res <- read.csv(file.path(results_dir, sprintf('fpr_%s.csv', exp_name)))
  tpr_res <- tpr_res[, c(1:5,7:8)]
  fpr_res <- fpr_res[, c(1:5,7:8)]
  
  p_tpr[[j]] <- ggplot(melt(tpr_res), aes(x=variable, y=value)) +
    geom_boxplot() +
    labs(x="", y="TPR", title=paste("Confounding level", confounding_level_vec[j])) +
    theme(axis.text.x=element_text(angle=45, hjust=1))
  p_fpr[[j]] <- ggplot(melt(fpr_res), aes(x=variable, y=value)) +
    geom_boxplot() +
    geom_hline(yintercept=0.05, col="red") +
    labs(x="", y="FPR", title=paste("Confounding level", confounding_level_vec[j])) +
    theme(axis.text.x=element_text(angle=45, hjust=1))
}

grid.arrange(p_fpr[[1]], p_tpr[[1]], p_fpr[[2]], p_tpr[[2]], 
             p_fpr[[3]], p_tpr[[3]], p_fpr[[4]], p_tpr[[4]], ncol=2)
```



## Combination of two factors 

### FPR

```{r, echo=FALSE, results='hide', fig.width=7.2, fig.height=9}
p_tpr <- p_fpr <- list(); k <- 1
for(i in 1:length(disp_level_vec)){
  for(j in 1:length(confounding_level_vec)){
    exp_name <- paste0("simDispConfound_dispFC", disp_level_vec[i],
                       "_percent", gsub(".","", confounding_level_vec[j], fixed=T))
    tpr_res <- read.csv(file.path(results_dir, sprintf('tpr_%s.csv', exp_name)))
    fpr_res <- read.csv(file.path(results_dir, sprintf('fpr_%s.csv', exp_name)))
    tpr_res <- tpr_res[, c(1:5,7:8)]
    fpr_res <- fpr_res[, c(1:5,7:8)]
    
    p_tpr[[k]] <- ggplot(melt(tpr_res), aes(x=variable, y=value)) +
      geom_boxplot() +
      labs(x="", y="TPR", title=paste("Disp:", disp_level_vec[i], "Confounding:", confounding_level_vec[j])) +
      theme(axis.text.x=element_text(angle=45, hjust=1)) +
      scale_y_continuous(limits=c(0.4, 1))
    p_fpr[[k]] <- ggplot(melt(fpr_res), aes(x=variable, y=value)) +
      geom_boxplot() +
      geom_hline(yintercept=0.05, col="red") +
      labs(x="", y="FPR", title=paste("Disp:", disp_level_vec[i], "Confounding:", confounding_level_vec[j])) +
      theme(axis.text.x=element_text(angle=45, hjust=1)) +
      scale_y_continuous(limits=c(0, 0.1))
    
    k <- k + 1
  }
}

# grid.arrange(p_fpr[[1]], p_tpr[[1]], p_fpr[[2]], p_tpr[[2]], p_fpr[[3]], p_tpr[[3]], p_fpr[[4]], p_tpr[[4]], 
#              p_fpr[[5]], p_tpr[[5]], p_fpr[[6]], p_tpr[[6]], p_fpr[[7]], p_tpr[[7]], p_fpr[[8]], p_tpr[[8]], 
#              p_fpr[[9]], p_tpr[[9]], p_fpr[[10]], p_tpr[[10]], p_fpr[[11]], p_tpr[[11]], p_fpr[[12]], p_tpr[[12]], 
#              p_fpr[[13]], p_tpr[[13]], p_fpr[[14]], p_tpr[[14]], p_fpr[[15]], p_tpr[[15]], p_fpr[[16]], p_tpr[[16]], 
#              p_fpr[[17]], p_tpr[[17]], p_fpr[[18]], p_tpr[[18]], p_fpr[[19]], p_tpr[[19]], p_fpr[[20]], p_tpr[[20]], 
#              ncol=8, nrow=5)
grid.arrange(p_fpr[[1]], p_fpr[[2]], p_fpr[[3]], p_fpr[[4]], p_fpr[[5]], 
             p_fpr[[6]], p_fpr[[7]], p_fpr[[8]], p_fpr[[9]], p_fpr[[10]], 
             p_fpr[[11]], p_fpr[[12]], p_fpr[[13]], p_fpr[[14]], p_fpr[[15]], 
             p_fpr[[16]], p_fpr[[17]], p_fpr[[18]], p_fpr[[19]], p_fpr[[20]],
             ncol=4, nrow=5)
```

### TPR

```{r, echo=FALSE, results='hide', fig.width=7.2, fig.height=9}
grid.arrange(p_tpr[[1]], p_tpr[[2]], p_tpr[[3]], p_tpr[[4]], p_tpr[[5]], 
             p_tpr[[6]], p_tpr[[7]], p_tpr[[8]], p_tpr[[9]], p_tpr[[10]], 
             p_tpr[[11]], p_tpr[[12]], p_tpr[[13]], p_tpr[[14]], p_tpr[[15]], 
             p_tpr[[16]], p_tpr[[17]], p_tpr[[18]], p_tpr[[19]], p_tpr[[20]],
             ncol=4, nrow=5)
```

## Thoughts & future work

* Explore real data (signature dataset)
* Computation time - need to optimize the algorithm?
